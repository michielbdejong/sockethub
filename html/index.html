<!DOCTYPE html lang="en">
<html>
  <head>
    <meta charset="utf-8">
    <title>pinger</title>
    <link rel="stylesheet" type="text/css" href="main.css">
  </head>
  <body>
    <div id="remotestorage-connect"></div>
    <p>
      <input id="sockethubHost" value="localhost:10550" >
      /sockethub
      <input type="submit" value="Reconnect" onclick="sockethub.reconnect();" >
      <button onclick="sockethub.togglePings()">Toggle Pings ON/OFF</button>
      <button onclick="sockethub.register(true)">Register</button>
    </p>
    <canvas id="myCanvas" style="border: 1px solid black;" width="560" height="50"></canvas>
    <p></p>
    <div id="controls">
      <a id="display-email" href="#" onclick="show('email');">email</a>
      <a id="display-xmpp" href="#" onclick="show('xmpp');">xmpp</a>
      <a id="display-twitter" href="#" onclick="show('twitter');">twitter</a>
      <a id="display-facebook" href="#" onclick="show('facebook');">facebook</a>
    </div>

    <!-- email -->
    <div id="email">
      <h1>email</h1>

      <a id="display-email-config" href="#" onclick="show('email', true);">toggle displaying credentials<br /></a>
      <div id="emailConfigContainer">
        <form name="emailConfig">
          <textarea name="source" rows="7" cols="80"> ... loading ...</textarea><br />
      </div><br />
          <input type="submit" value="set" id="saveEmailConfig">
          <input type="hidden" name="platform" value="email">
          <input type="hidden" name="configType" value="credentials">
          <input type="text" name="location" disabled="disabled" size="60" value="/sockethub/credentials/email">
        </form>

      <h2>message</h2>
      <form name="emailMessage">
        <input type="hidden" name="platform" value="email">
        <h3>from</h3>
        <label for="emailAccounts">email accounts</label>
        <select name="emailAccounts" id="emailAccounts"></select>
        <input type="hidden" size="60" name="fromName">
        <input type="hidden" size="60" name="fromAddress">
        <h3>to</h3>
        <label for="toName">name</label><input type="text" size="60" name="toName"><br />
        <label for="toAddress">address</label><input type="text" size="60" name="toAddress"><br />

        <label for="subject">subject</label><input type="text" size="60" name="subject"><br />
        <label for="body">body</label><br />
        <textarea name="body" rows="7" cols="80"></textarea>
        <br />
        <input type="submit" value="send" id="submitEmailMessage">
      </form>
    </div>

    <!-- xmpp -->
    <div id="xmpp">
      <h1>xmpp</h1>

      <a href="#" onclick="show('xmpp', true);">toggle config</a><br />
      <div id="xmppConfigContainer">
        <form name="xmppConfig">
          <textarea name="source" rows="7" cols="80"> ... loading ...</textarea><br />
      </div><br />
          <input type="submit" value="set" id="saveXmppConfig">
          <input type="hidden" name="platform" value="xmpp">
          <input type="hidden" name="configType" value="credentials">
          <input type="text" name="location" disabled="disabled" size="60" value="/sockethub/credentials/xmpp">
        </form>

      <form name="xmppMessage">
        <p>
        <label for="xmppAccounts">xmpp accounts</label>
        <select name="xmppAccounts" id="xmppAccounts"></select></p>
        <p>
        <label for="fromAddress">
          From:
        </label>
        <input type="hidden" name="fromName" value="">
        <input type="text" name="fromAddress" value="">
        <label for="toAddress">
          To:
        </label>
        <input type="hidden" name="toName" value="">
        <input type="text" name="toAddress" value="">
        </p>
      <h2>incoming messages</h2>
        <textarea name="xmppIncomingMessages" rows="7" cols="80"></textarea><br />
      <h2>send message</h2>
        <p><label for="sendMessage">
          Text:
        </label></p>
        <input type="text" name="sendMessage" size="60" value="">
        <br/>
        <input type="submit" value="send" id="submitXmppMessage">
      </form>
    </div>

    <!-- twitter -->
    <div id="twitter">
      <h1>twitter</h1>

      <a href="#" onclick="show('twitter', true);">toggle config</a><br />
      <div id="twitterConfigContainer">
        <form name="twitterConfig">
          <textarea name="source" rows="7" cols="80"> ... loading ... </textarea><br />
        </div><br />
          <input type="submit" value="set" id="saveTwitterConfig">
          <input type="hidden" name="platform" value="twitter">
          <input type="hidden" name="configType" value="credentials">
          <input type="text" name="location" disabled="disabled" size="60" value="/sockethub/credentials/twitter">
        </form>

      <h2>post</h2>
      <form name="twitterPost">
        <input type="hidden" name="platform" value="twitter">
        <h3>from</h3>
        <label for="twitterAccounts">twitter accounts</label>
        <select name="twitterAccounts" id="twitterAccounts"></select>
        <input type="hidden" size="60" name="fromName">
        <input type="hidden" size="60" name="fromAddress">
        <h3>to</h3>
        <label for="toAddress">address</label><input type="text" size="60" name="toAddress"><br />
        <label for="body">body</label><br />
        <textarea name="body" rows="7" cols="80"></textarea>
        <br />
        <input type="submit" value="send" id="submitTwitterPost">
      </form>
    </div>

    <!-- facebook -->
    <div id="facebook">
      <h1>facebook</h1>

      <a href="#" onclick="show('facebook', true);">toggle displaying credentials<br /></a>
      <div id="facebookConfigContainer">
        <form name="facebookConfig">
          <textarea name="source" rows="7" cols="80"> ... loading ...</textarea><br />
      </div><br />
          <input type="submit" value="set" id="saveFacebookConfig">
          <input type="hidden" name="platform" value="facebook">
          <input type="hidden" name="configType" value="credentials">
          <input type="text" name="location" disabled="disabled" size="60" value="/sockethub/credentials/facebook">
        </form>

      <h2>post</h2>
      <form name="facebookPost">
        <input type="hidden" name="platform" value="facebook">
        <h3>from</h3>
        <label for="facebookAccounts">facebook accounts</label>
        <select name="facebookAccounts" id="facebookAccounts"></select>
        <input type="hidden" size="60" name="fromName">
        <input type="hidden" size="60" name="fromAddress">
        <h3>to</h3>
        <label for="toAddress">address</label><input type="text" size="60" name="toAddress"><br />
        <label for="body">body</label><br />
        <textarea name="body" rows="7" cols="80"></textarea>
        <br />
        <input type="submit" value="send" id="submitFacebookPost">
      </form>
    </div>

    <!-- log -->
    <pre id="log"></pre>

    <script>
var actors = {};
var exampleConfig = {
  email: {
    credentials: {
      'user@example.com': {
        actor: {
          name: "Example User",
          address: "user@example.com"
        },
        smtp: {
          username: 'user@example.com',
          password: '123456',
          host: 'example.com',
        }
      }
    }
  },
  xmpp: {
    credentials: {
      'user@example.com': {
        actor: {
          name: "Bob Userman",
          address: "user@example.com"
        },
        username: 'user',
        password: 'abcde',
        server: 'example.com',
        resource: 'Home'
      }
    }
  },
  twitter: {
    credentials: {
      'example_user': {
        actor: {
          address: "example_user",
        },
        consumer_key: 'abcde',
        consumer_secret: '1234',
        access_token: 'abcde',
        access_token_secret: '1234'
      }
    }
  },
  facebook: {
    credentials: {
      'example_user': {
        actor: {
          address: "example_user",
        },
        access_token: 'abcde'
      }
    }
  }
};

document.getElementById('emailAccounts').addEventListener('click', function (e) {
  if (e.preventDefault) { e.preventDefault(); }
  var form = e.target.form;
  console.log('HELLO WORLD',e);
  /*if ((!form.platform.value) ||
      (!form.configType.value)) {
    sockethub.log(3, null, 'body must contain something');
    return false;
  }*/

}, false);

document.getElementById('saveEmailConfig').addEventListener('click', saveConfigEvent, false);
document.getElementById('saveFacebookConfig').addEventListener('click', saveConfigEvent, false);
document.getElementById('saveTwitterConfig').addEventListener('click', saveConfigEvent, false);
document.getElementById('saveXmppConfig').addEventListener('click', saveConfigEvent, false);

function saveConfigEvent(e) {
  if (e.preventDefault) { e.preventDefault(); }

  var form = e.target.form;

  if ((!form.source.value) ||
      (!form.platform.value) ||
      (!form.configType.value)) {
    sockethub.log(3, null, 'body must contain something');
    return false;
  }

  var data;
  try {
    data = JSON.parse(form.source.value);
  } catch (e) {
    sockethub.log(3, null, 'config not valid json data');
    return false;
  }

  console.log('saveConfigEvent platform['+form.platform.value+']');
  remoteStorage.sockethub.writeConfig(form.platform.value,
                                      form.configType.value,
                                      data).then(function (ret) {
                                        sockethub.log(2, null, 'config saved!');
                                      });

  sockethub.set(form.platform.value, data);
  populateActors(form.platform.value, data);
  return false;
}


document.getElementById('submitEmailMessage').addEventListener('click', function (e) {
  if (e.preventDefault) { e.preventDefault(); }
  var form = e.target.form;

  if ((!form.fromAddress.value) ||
      (!form.toAddress.value) ||
      (!form.subject.value) ||
      (!form.body.value)) {
    sockethub.log(3, null, 'required fields: from address, to address, subject and body.');
    return false;
  }

  var o = {
    actor: {
      name: (form.fromName.value) ? form.fromName.value : '',
      address: form.fromAddress.value,
    },
    target: {
      to: [
        {
          name: (form.toName.value) ? form.toName.value : '',
          address: form.toAddress.value,
        }
      ]
    },
    object: {
      subject: form.subject.value,
      text: form.body.value
    }
  };

  sockethub.send('email', o.actor, o.target, o.object);
  return false;
}, false);


document.getElementById('submitXmppMessage').addEventListener('click', function (e) {
  if (e.preventDefault) { e.preventDefault(); }
  var form = e.target.form;

  if ((!form.fromAddress.value) ||
      (!form.toAddress.value) ||
      (!form.sendMessage.value)) {
    sockethub.log(3, null, 'required fields: from address, to address, send message.');
    return false;
  }

  var o = {
    actor: {
      name: (form.fromName.value) ? form.fromName.value : '',
      address: form.fromAddress.value,
    },
    target: {
      to: [
        {
          address: form.toAddress.value,
        }
      ]
    },
    object: {
      text: form.sendMessage.value
    }
  };

  sockethub.send('xmpp', o.actor, o.target, o.object);
  return false;
}, false);


document.getElementById('submitFacebookPost').addEventListener('click', function (e) {
  if (e.preventDefault) { e.preventDefault(); }
  var form = e.target.form;

  if ((!form.toAddress.value) ||
      (!form.body.value)) {
    sockethub.log(3, null, 'required fields: to address, and body.');
    return false;
  }

  var o = {
    actor: {
      address: form.fromAddress.value,
    },
    target: {
      to: [
        {
          address: form.toAddress.value,
        }
      ]
    },
    object: {
      text: form.body.value
    }
  };

  sockethub.post('facebook', o.actor, o.target, o.object);
  return false;
}, false);

document.getElementById('submitTwitterPost').addEventListener('click', function (e) {
  if (e.preventDefault) { e.preventDefault(); }
  var form = e.target.form;

  if ((!form.toAddress.value) ||
      (!form.body.value)) {
    sockethub.log(3, null, 'required fields: to address, and body.');
    return false;
  }

  var o = {
    actor: {
      address: form.fromAddress.value,
    },
    target: {
      to: [
        {
          address: form.toAddress.value,
        }
      ]
    },
    object: {
      text: form.body.value
    }
  };

  sockethub.post('twitter', o.actor, o.target, o.object);
  return false;
}, false);


function show(platform, config) {
  var e;
  if (config) {
    e = document.getElementById(platform+'ConfigContainer');
  } else {
    e = document.getElementById(platform);
  }
  if (e === null) {
    return;
  }
  if (e.style.display === 'inline-block') {
    e.style.display = 'none';
  } else {
    e.style.display = 'inline-block';
    var formName = platform+'Config';
    remoteStorage.sockethub.getConfig(platform, 'credentials').then(function (data) {
      console.log('rs got: ',data);
      if (data === undefined) {
        document[formName].source.value = JSON.stringify(exampleConfig[platform]);
      } else {
        document[formName].source.value = JSON.stringify(data);
        populateActors(platform, data);
      }
    }, function (err) {
      console.log(' rs error: ', err);
      document[formName].source.value = JSON.stringify(exampleConfig[platform]);
    });
  }
  console.log('show end');
}


function populateActors(platform, data) {
  if (data.credentials) {
    data = data.credentials;
  }
  console.log('populateActors after: ',data);
  var keys = Object.keys(data);
  for (var i = 0, num = keys.length; i < num; i = i + 1) {
    if (keys[i] === '@type') { continue; }
    var key = keys[i];
    if (typeof data[key].actor !== 'undefined') {
      if (typeof actors[platform] === 'undefined') { actors[platform] = {}; }
      actors[platform][key] = {
        name: (data[key].actor.name) ? data[key].actor.name : (data[key].actor.address) ? data[key].actor.address : "",
        address: (data[key].actor.address) ? data[key].actor.address : "",
      };
    }
  }

  console.log('actors:',actors);
  var first = true;
  if (typeof actors[platform] !== 'undefined') {
    var formName;
    if ((platform === 'facebook') ||
        (platform === 'twitter')) {
      formName = platform+'Post';
    } else {
      formName = platform+'Message';
    }
    console.log('platform: '+platform+' formName:'+formName+' accounts:'+platform+'Accounts');
    var s = document.getElementById(platform+"Accounts");
    s.options.length = 0;
    var keys = Object.keys(actors[platform]);
    for (var i = 0, num = keys.length; i < num; i = i + 1) {
      if (keys[i] === '@type') { continue; }
      var key = keys[i];
      console.log('key:'+key);
      s.options[s.options.length]= new Option(actors[platform][key].address, actors[platform][key].name);
      if (first) {
        setForm(formName, platform, actors[platform][key].address);
        first = false;
      }
    }
  }
  console.log('populateActors end');
}

function setForm(formName, platform, key) {
  console.log('setForm: '+formName+', '+platform+', '+key);
  document[formName].fromName.value = actors[platform][key].name;
  document[formName].fromAddress.value = actors[platform][key].address;
  console.log('setForm end');
}
    </script>
  </body>
  <script src="sockethub-example.js"></script>
  <script src="remoteStorage.min.js"></script>
</html>
